# 第6章：アーキテクチャ・技術選定書ガイド
**〜コードの「住所」を決め、大切なロジックを守る城壁〜**

## 1. はじめに：なぜ「動けばいい」ではダメなのか
小規模な開発やプロトタイプ作成では、一つのファイルに全ての処理を書いたり、データベースの都合でロジックを曲げたりしても、動作すれば問題なかったかもしれません。

しかし、チーム開発でそれを継続すると、保守性が**「崩壊」**します。
「画面の仕様を変えたら、決済ロジックに影響が出た」——そんな事態を防ぐために必要なのが、**アーキテクチャ（構造）**です。

特に今回はDDD（ドメイン駆動設計）を採用します。
これは、第4章で設計した「ドメインモデル（業務のルール）」を、**フレームワークやデータベースの都合から徹底的に守る**ための構造です。

このドキュメントは、**「どのコードを、どのフォルダに置くべきか」**という住所録であり、重要なドメインロジックを守るための**城壁の設計図**です。

---

## 2. 本書の定義：技術の枠組みとルール

### 定義
システムを開発するために使用する「道具（言語・ツール）」と、コードを配置する「構造（パターン）」を定義した合意文書です。

### 目的（Purpose）
1.  **関心の分離:** 「画面を表示するコード」と「計算するコード」と「保存するコード」を明確に分け、お互いの影響を最小限にする。
2.  **テスタビリティ（テストしやすさ）:** データベースやWebサーバーを起動しなくても、ビジネスロジック（計算ルール）単体で高速にテストできるようにする。

---

## 3. DDDを支える「層（Layer）」の考え方

本プロジェクトでは、一般的に**「オニオンアーキテクチャ（またはクリーンアーキテクチャ）」**と呼ばれる構成を採用します。
この構造には明確な「依存の方向」があります。

### 中心：ドメイン層 (Domain Layer)
*   **住人:** 第4章で定義した「エンティティ」「値オブジェクト」。
*   **ルール:** ここは**聖域**です。WebフレームワークやDBの都合（SQLなど）を一切持ち込んではいけません。純粋なプログラミング言語（JavaやTypeScriptなど）の機能だけで、ビジネスルールを記述します。
*   **依存:** 誰にも依存しません（他層を知りません）。

### 中間：ユースケース層 (Application Layer)
*   **住人:** 第2章の「ユーザーストーリー」を実現する進行役（Service）。
*   **ルール:** ドメイン層のオブジェクトを使って、「リポジトリから取り出す→計算させる→保存する」という手順を指揮します。

### 外側：インフラ/プレゼンテーション層 (Infrastructure / UI)
*   **住人:** Webコントローラー、DBアクセス(SQL)、外部APIクライアント。
*   **ルール:** ユーザーからの入力を受け取ったり、実際にDBに書き込んだりする「具体装飾」の部分です。
*   **依存:** 内側の層（ドメインやユースケース）を使います。

**【重要】依存の原則**
矢印は常に**「外側から内側」**にしか向きません。
DB操作のクラス（外）がドメイン（内）を使うのはOKですが、**ドメイン（内）がDB操作（外）に依存してはいけません**。

---

## 4. 執筆ガイドライン（決定事項）

プロジェクトごとにゼロから「オニオンアーキテクチャ」のディレクトリ構成を考えるのはコストがかかります。
本プロジェクトでは、推奨される**テンプレートリポジトリ（ボイラープレート）**を用意しています。
この章の目的は、独自のアート作品を作ることではなく、**「用意された枠組みのどこに、コードを配置するか」**を理解することです。

### ① アーキテクチャパターン (Pattern)
*   「オニオンアーキテクチャ」や「レイヤードアーキテクチャ」など、採用する型を宣言します。
*   **ディレクトリ構成:** 実際のフォルダ構造（`src/domain`, `src/infrastructure` など）をツリー形式で書き、どこに何を入れるか定義します。

### ② 技術スタック (Tech Stack)
「使い慣れているから」ではなく、「PoCの要件に合うから」という理由で選定します。
*   **言語/FW:** TypeScript (Next.js), Go (Gin), Java (Spring Boot) など。
*   **データベース:** RDB (MySQL/PostgreSQL) なのか、NoSQL (Firestore) なのか。
    *   ※ドメインモデルの構造を守れるものを選びます。
*   **インフラ:** AWS, Vercel, Google Cloud など。

### ③ コーディング規約・ツール (Conventions)
*   **Linter/Formatter:** ESLint, Prettier など、コードの見た目を統一するツール。
*   **テストツール:** Jest, JUnit など。

---

## 5. 設計の原則：フレームワークに使われるな

現代の開発では、便利なWebフレームワーク（Rails, Laravel, Next.jsなど）がたくさんあります。
これらは素晴らしいツールですが、**「フレームワークの作法」に「業務ルール」を合わせさせてしまう**というリスクがあります。

**「主役はドメイン（業務ルール）。フレームワークは、それをWebに表示するための入出力装置にすぎない」**と考えてください。
フレームワークを交換しても中身のロジックはそのまま使える。そんな**「疎結合（そけつごう）」**な設計を目指してください。

---

## 6. 完了定義 (Definition of Done)
次の章に進む前に、以下のチェックをクリアしてください。

*   [ ] チームで推奨されているボイラープレート（雛形）を確認したか？
*   [ ] 「ドメインロジック」をどのフォルダに書くか、指差し確認できるか？
*   [ ] **【レビュー】** テックリード（技術責任者）に、選定した技術と構成がプロジェクトの要件に合っているか承認をもらうこと。
